---
title: 事件目录
---

当Cypress在浏览器中运行时，它会发出一系列事件。

这些事件不仅对控制应用程序的行为很有用，而且对调试也很有用。

下面是一些你可以用这些事件来做的例子:

- 监听`uncaught exceptions`，防止Cypress测试失败
- 留意`alert` or `confirm`的调用，改变`confirm`的行为
- 监听`window:before:load`事件，并在你的任何应用代码在页面转换之间运行之前修改`window`
- 监听`command:retry`事件，为了调试目的,了解为什么Cypress在内部重试

## 事件类型

### 应用程序事件

这些事件来自当前被测试的应用程序(您的应用程序)。这些都是你应该听的最有用的事件。

| 事件             | 详细说明                                                                                                                                                                                                                                                                                                                                           |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**         | `uncaught:exception`                                                                                                                                                                                                                                                                                                                              |
| **参数:**         | the error **(Object)**, Mocha runnable **(Object)**                                                                                                                                                                                                                                                                                               |
| **描述:**         | 当应用程序中发生未捕获异常时触发。一旦触发，Cypress测试会失败. 从这个事件返回`false`， Cypress会阻止失败. 对于调试也很有用，因为实际上`error`实例已经提供给您了. 参见我们的配方[处理错误](/examples/examples/recipes#Fundamentals). |

| 事件             | 详细说明                                                                                                                                                                       |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `window:confirm`                                                                                                                                                              |
| **参数:**        | 确认文本 **(String)**                                                                                                                                            |
| **描述:**        | 当你的应用程序调用全局方法`window.confirm()`时触发. Cypress将自动接受确认.从这个事件返回`false`，确认将被取消. |

| 事件             | 详细说明                                                                                                                         |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `window:alert`                                                                                                                  |
| **参数:**        | 警报的文本**(String)**                                                                                                     |
| **描述:**        | 当应用程序调用全局的`window.alert()`方法时触发. 赛普拉斯将自动接受警报。你不能改变这种行为.                                      |

| 事件             | 详细说明                                                                                                                                                                                                                     |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `window:before:load`                                                                                                                                                                                                        |
| **参数:**        | 远程 window **(Object)**                                                                                                                                                                                              |
| **描述:**        | 在页面开始加载时触发，但在任何应用程序JavaScript执行之前触发. 这与`cy.visit()` `onBeforeLoad`的回调在同一时间触发. 用于在页面转换时修改window. |

| 事件             | 详细说明                                                                                                                                              |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `window:load`                                                                                                                                        |
| **参数:**        | 远程 window **(Object)**                                                                                                                       |
| **描述:**        | 在页面转换后，在所有资源完成加载后触发. 这与`cy.visit()` `onLoad` 回调函数在同一时间触发. |

| 事件             | 详细说明                                                                                                                                                                            |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `window:before:unload`                                                                                                                                                             |
| **参数:**        | 实际的 beforeunload 事件 **(Object)**                                                                                                                                         |
| **描述:**        | 当应用程序要导航时触发. 将提供给您真实的事件对象. 你的应用程序可能已经在事件上设置了一个`returnValue`，这对断言是有用的. |

| 事件             | 详细说明                                                                                                                                  |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `window:unload`                                                                                                                          |
| **参数:**        | 实际的 unload 事件 **(Object)**                                                                                                     |
| **描述:**        | 当您的应用程序已卸载并正在导航时触发. 真实的事件对象将提供给您. 此事件不可取消. |

| 事件             | 详细说明                                                                 |
| ---------------- | ----------------------------------------------------------------------- |
| **名称:**        | `url:changed`                                                           |
| **参数:**        | 新 url **(String)**                                                |
| **描述:**        | 当Cypress检测到您的应用程序的URL已更改时触发. |

### Cypress 事件

这些事件来自Cypress，因为它发出命令并对他们的状态作出反应。对于调试而言，这些都是非常有用的.

| 事件             | 详细说明                                                                                                                                                                                                                                                                                                                                                                                                 |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `fail`                                                                                                                                                                                                                                                                                                                                                                                                  |
| **参数:**        | the error **(Object)**, Mocha runnable **(Object)**                                                                                                                                                                                                                                                                                                                                                     |
| **描述:**        | 当测试失败时发射. 通过绑定到此事件并调用一个异步`done`回调，在技术上可以防止测试实际失败. 然而，**强烈反对**这种做法. 测试永远不应该合法失败. 这个事件的存在是因为它对调试非常有用. 参见我们的配方[处理错误](/examples/examples/recipes#Fundamentals). |

| 事件             | 详细说明                                                                                                                                                              |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `viewport:changed`                                                                                                                                                   |
| **参数:**        | 新viewport **(Object)**                                                                                                                                        |
| **描述:**        | 当viewport通过 `cy.viewport()`改变时触发，或者当Cypress在测试之间将viewport重置为默认值时自然触发. 对调试有用. |

| 事件             | 详细说明                                                                                                                                                                                                                                                                                                                                                |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **名称:**        | `scrolled`                                                                                                                                                                                                                                                                                                                                             |
| **参数:**        | 被滚动的元素或窗口 **(Object)**                                                                                                                                                                                                                                                                                                      |
| **描述:**        | 每当**Cypress**滚动你的应用程序时都会触发. 当Cypress[等待并计算可操作性](/guides/core-concepts/interacting-with-elements)时触发此事件. 它会滚动“被覆盖”的元素到不被覆盖. 这个事件对于调试为什么Cypress认为一个元素不是交互式的非常有用. |

| 事件             | 详细说明                                                                                                                                                                 |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `command:enqueued`                                                                                                                                                      |
| **参数:**        | 命令属性和参数 **(Object)**                                                                                                                           |
| **描述:**        | 在第一次调用cy命令并将其放入队列以便稍后运行时触发. 如果您对命令的执行顺序感到困惑，这对调试很有用。 |

| 事件             | 详细说明                                                                                                                                  |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `command:start`                                                                                                                          |
| **参数:**        | 命令实例 **(Object)**                                                                                                            |
| **描述:**        | 当cy开始实际运行并执行您的命令时触发. 用于调试和理解命令队列是异步的. |

| 事件             | 详细说明                                                                                                                     |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `command:end`                                                                                                               |
| **参数:**        | 命令实例 **(Object)**                                                                                               |
| **描述:**        | 当cy完成运行并执行你的命令时触发. 对于调试和理解命令是如何处理的很有用. |

| 事件             | 详细说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `command:retry`                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **参数:**        | 重试选项 **(Object)**                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **描述:**        | 每当命令开始它的[重试例程](/guides/core-concepts/retry-ability)时触发. 这在Cypress内部等待重试间隔后的后缘被调用. 有助于理解**为什么**命令正在重试, 通常包括导致重试发生的实际错误. 当命令失败时，最后一个错误实际上是导致测试失败的错误. 这个事件本质上是调试Cypress失败的原因. |

| 事件             | 详细说明                                                                                                                                                                                         |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `log:added`                                                                                                                                                                                     |
| **参数:**        | 日志属性 **(Object)**, Cypress是否处于交互模式 (是否通过 `cypress open`运行) **(Boolean)**                                                                                  |
| **描述:**        | 每当命令发出此事件时触发，以便它可以在命令日志中显示. 了解内部cypress命令如何利用[cypress .log()](/api/cypress-api/cypress-log)API非常有用. |

| 事件             | 详细说明                                                                                                                                                                                                                                |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **名称:**        | `log:changed`                                                                                                                                                                                                                          |
| **参数:**        | 日志属性 **(Object)**,Cypress是否处于交互模式 (是否通过 `cypress open`运行) **(Boolean)**                                                                                                                           |
| **描述:**        | 每当命令的属性更改时触发。 这个事件被防反跳（debounced），以防止它触发太快和太频繁. 了解内部cypress命令如何利用[Cypress.log()](/api/cypress-api/cypress-log) API非常有用。 |

| 事件             | 详细说明                                                                |
| ---------------- | ---------------------------------------------------------------------- |
| **名称:**        | `test:before:run`                                                      |
| **参数:**        | 测试属性 **(Object)**, 可运行实例 **(Object)**           |
| **描述:**        | 在测试和**before** 以及 **beforeEach**钩子前触发. |

| 事件             | 详细说明                                                             |
| ---------------- | ------------------------------------------------------------------- |
| **名称:**        | `test:after:run`                                                    |
| **参数:**        | 测试属性 **(Object)**, 可运行实例 **(Object)**          |
| **描述:**        | 在测试和所有**afterEach** 和 **after** 之后触发. |

### 其他事件

在与Node服务器进程、自动化服务器、Mocha、运行器和报表通信时，Cypress还会触发无数其他事件。 它们严格按照Cypress的工作方式进行，对用户没有用处.

## 绑定事件

全局的 `Cypress` and `cy`对象都是标准的Node事件发射器. 这意味着您可以使用以下方法绑定和解除绑定事件.

- [on](https://nodejs.org/api/events.html#events_emitter_on_eventname_listener)
- [once](https://nodejs.org/api/events.html#events_emitter_once_eventname_listener)
- [removeListener](https://nodejs.org/api/events.html#events_emitter_removelistener_eventname_listener)
- [removeAllListeners](https://nodejs.org/api/events.html#events_emitter_removealllisteners_eventname)

理解为什么要绑定到 `Cypress` 和 `cy`是很重要的.

### Cypress

Cypress是一个全局对象，它在所有测试中都持续存在. 绑定到Cypress的任何事件将应用于所有测试，并且除非手动解除绑定，否则不会解除绑定.

当您正在调试并希望添加一个`全局捕获`事件来跟踪测试失败或应用程序中未捕获的异常时，这是非常有用的。

### cy

`cy`对象绑定到每个单独的测试. 当测试结束时，绑定到`cy`的事件将被自动删除. 您不必担心清理问题，并且您的事件监听器只会在单个测试期间被调用。

## 例子

### 未捕获异常

#### 关闭所有未捕获的异常处理

```javascript
//你可能想在 support文件中添加下面的代码
// 这样就能应用到所有的spec文件
// cypress/support/index.js

Cypress.on('uncaught:exception', (err, runnable) => {
  // 返回false可以防止Cypress测试失败
  return false
})
```

### 对某个错误有条件地关闭未捕获异常处理

```javascript
//你可能想在 support文件中添加下面的代码
// 这样就能应用到所有的spec文件
// cypress/support/index.js
Cypress.on('uncaught:exception', (err, runnable) => {
  // 我们期望有对 '未定义清单'这个错误消息，返回false，让测试不失败
  if (err.message.includes('未定义清单')) {
    return false
  }
  //我们仍然希望确保没有其他意外的错误，所以我们让它们无法通过测试
})
```

### 有条件地关闭未捕获异常处理，一个未处理的被拒绝的promise

```javascript
//你可能想在 support文件中添加下面的代码
// 这样就能应用到所有的spec文件
// cypress/support/index.js
Cypress.on('uncaught:exception', (err, runnable, promise) => {
  // 当异常源于未处理的被拒绝promise时，promise将作为第三个参数提供
  // 在这种情况下，您可以阻止“测试失败”
  if (promise) {
    return false
  }
  // 我们仍然希望确保没有其他意外的错误，所以我们让它们无法通过测试
})
```

#### 捕获单个未捕获的异常

```javascript
it('is doing something very important', (done) => {
  //当测试结束时，该事件将自动解除绑定，因为它被附加到`cy`
  cy.on('uncaught:exception', (err, runnable) => {
    expect(err.message).to.include('something about the error')

    // 使用mocha的async done回调来完成这个测试，这样我们就可以证明抛出了一个未捕获的异常
    done()

    // 返回false以防止这个错误导致测试失败
    return false
  })

  // 假设这会导致错误
  cy.get('button').click()
})
```

### 捕捉测试失败

#### 在测试失败时进行调试

```javascript
// 如果您想在任何测试失败时进行调试
// 你可能想把它放在support文件中，
// 或者放在单个spec文件的顶部
Cypress.on('fail', (error, runnable) => {
  debugger

  // 现在，我们可以访问error 实例和发生故障的mocha可运行对象

  throw error // 抛出错误使测试仍然失败
})

it('当测试失败时调用"fail"回调', () => {
  // 当这个cyl .get()失败时，回调函数将被调用并产生错误
  cy.get('一个不存在的元素')
})
```

阅读[Cypress 元编程](https://glebbahmutov.com/blog/cy-metaprogramming/) 以获得更多示例。

### 页面导航

#### 测试应用程序是否被重定向

```javascript
// 应用程序代码
$('button').on('click', (e) => {
  // 以编程方式更改页面
  window.location.href = '/some/new/link'
})

// 测试代码
it('点击触发重定向到另一个页面', (done) => {
  // 当测试结束时，该事件将自动解除绑定，因为它被附加到'cy'
  cy.on('window:before:unload', (e) => {
    // 事件没有返回值
    expect(e.returnValue).to.be.undefined
  })

  cy.on('window:unload', (e) => {
    // 使用mocha的async done回调来完成这个测试，这样我们就可以保证在导航到新页面时应用程序被卸载了
    done()
  })

  // 单击导致页面重定向的按钮
  cy.get('button').click()
})
```

### 窗口加载之前

####在页面转换后加载应用程序之前修改它

```javascript
it('可以在页面加载之前修改窗口中的所有页面吗', () => {
  // 在这里创建桩
  const ga = cy.stub().as('ga')

  //防止加载谷歌分析，并在每个页面加载之前用桩替换它，包括所有新的页面导航
  cy.on('window:before:load', (win) => {
    Object.defineProperty(win, 'ga', {
      configurable: false,
      get: () => ga, // 总是返回桩
      set: () => {}, // 不允许实际的谷歌分析覆盖此属性
    })
  })

  cy
    // window:before:load 将在这里被调用
    .visit('/first/page')

    .then((win) => {
      // 以及这里
      win.location.href = '/second/page'
    })

    // 以及这里
    .get('a')
    .click()
})
```

### 确认弹窗

#### 控制是否接受或拒绝

这使您能够测试应用程序如何对接受的确认和拒绝的确认作出反应。

<!-- textlint-disable -->

```javascript
// 应用程序代码
$('button').on('click', (e) => {
  const one = confirm('first confirm')

  if (one) {
    const two = confirm('second confirm')

    if (!two) {
      const three = confirm('third confirm')

      confirm('third confirm was ' + three)
    }
  }
})

// 测试代码
it('能否控制应用程序的确认弹窗的确认', (done) => {
  let count = 0

  // 确保你在应用程序中调用confirm方法之前绑定到这个事件，
  // 并将在测试结束时自动解除绑定，因为它被附加到'cy'
  cy.on('window:confirm', (str) => {
    count += 1

    switch (count) {
      case 1:
        expect(str).to.eq('first confirm')
      // 此处不返回任何内容，将自动接受确认
      case 2:
        expect(str).to.eq('second confirm')

        // 拒绝确认
        return false

      case 3:
        expect(str).to.eq('third confirm')

        // 不必返回true，但它工作得很好
        return true

      case 4:
        expect(str).to.eq('third confirm was true')

        // 使用mocha的async done回调来完成这个测试，这样我们就可以保证一切顺利，不会抛出错误
        done()
    }
  })

  // 点击按钮，导致触发确认弹窗
  cy.get('button').click()
})

it('也可以使用桩而不是命令式代码', () => {
  const stub = cy.stub()

  // 没有必须的，但为了清晰起见
  stub.onFirstCall().returns(undefined)
  stub.onSecondCall().returns(false)
  stub.onThirdCall().returns(true)

  cy.on('window:confirm', stub)

  cy.get('button')
    .click()
    .then(() => {
      expect(stub.getCall(0)).to.be.calledWith('first confirm')
      expect(stub.getCall(1)).to.be.calledWith('second confirm')
      expect(stub.getCall(2)).to.be.calledWith('third confirm')
      expect(stub.getCall(3)).to.be.calledWith('third confirm was true')
    })
})
```

<!-- textlint-enable -->

### 警告弹窗

#### 断言警告文本

Cypress自动接受提醒，但您仍然可以断言文本内容。

```javascript
// 应用程序代码
$('button').on('click', (e) => {
  alert('hi')
  alert('there')
  alert('friend')
})

it('能否断言警告文本内容', () => {
  const stub = cy.stub()

  cy.on('window:alert', stub)

  cy.get('button')
    .click()
    .then(() => {
      expect(stub.getCall(0)).to.be.calledWith('hi')
      expect(stub.getCall(1)).to.be.calledWith('there')
      expect(stub.getCall(2)).to.be.calledWith('friend')
    })
})
```

## 注意

### 记录所有事件到日志

Cypress使用 [`debug`](https://github.com/visionmedia/debug) node模块用于后端服务器进程，以及在浏览器中运行的所有程序(称为驱动程序)。

如果你想看到Cypress发出的(巨大的)事件流，你可以打开你的Dev Tools并在控制台编写这一行。

```javascript
localStorage.debug = 'cypress:*'
```

重新加载浏览器并打开“Verbose”日志以查看Developer Tools控制台中的调试消息。

<DocsImage src="/img/api/catalog-of-events/console-log-events-debug.png" alt="console log events for debugging" ></DocsImage>
